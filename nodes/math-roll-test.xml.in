<?xml version="1.0" standalone="no"?>

<kickstart>

<description>
The math roll installation test.
</description>

<copyright>
Copyright (c) 2000 - 2011 The Regents of the University of California.
All rights reserved. Rocks(r) v5.1 www.rocksclusters.org
</copyright>

<changelog>
</changelog>

<post>

/bin/mkdir -m 0755 /root/rolltests

<file name="/root/rolltests/math.t" perms="0755">
<![CDATA[#!/usr/bin/perl -w
# math roll installation test.  Usage:
# math.t [nodetype]
#   where nodetype is one of "Compute", "Dbnode", "Frontend" or "Login"
#   if not specified, the test assumes either Compute or Frontend

use Test::More qw(no_plan);

my $appliance = $#ARGV >= 0 ? $ARGV[0] :
                -d '/export/rocks/install' ? 'Frontend' : 'Compute';
my $installedOnAppliancesPattern = '.';
my @packages = ('gsl', 'lapack', 'octave', 'parmetis', 'petsc',
                'scalapack', 'sprng', 'superlu', 'trilinos');
my $output;
my @COMPILERS = (
  'ROLLCOMPILER',
);
my $TESTFILE = 'tmpmath';

# math-install.xml
foreach my $package(@packages) {
  if($appliance =~ /$installedOnAppliancesPattern/) {
    ok(-d "/opt/$package", "$package installed");
  } else {
    ok(! -d "/opt/$package", "$package not installed");
  }
}

SKIP: {

  skip 'modules not installed', 1 if ! -f '/etc/profile.d/modules.sh';

  foreach my $package(@packages) {
    skip "$package not installed", 3 if ! -d "/opt/$package";
    foreach my $compiler(@COMPILERS) {
      my $path = '/opt/modulefiles/applications' .
                 ($package eq 'octave' ? '' : "/.$compiler");
      my $subpackage = $package eq 'octave' ? $package : "$package/$compiler";
      `/bin/ls $path/$package/[0-9]* 2>&1`;
      ok($? == 0, "$subpackage module installed");
      `/bin/ls $path/$package/.version.[0-9]* 2>&1`;
      ok($? == 0, "$subpackage version module installed");
      ok(-l "$path/$package/.version",
         "$subpackage version module link created");
      last if $package eq 'octave';
    }
  }

}


# gsl
foreach my $c (@COMPILERS) {
  my $packageHome = "/opt/gsl/$c";
  my $testDir = "/opt/gsl/$c/tests";
  SKIP: {
    skip "gsl/$c not installed", 1 if ! -d $packageHome;
    skip "gsl/$c test not installed", 1 if ! -d $testDir;
    open(OUT, ">$TESTFILE.sh");
    print OUT <<END;
#!/bin/bash
. /etc/profile.d/modules.sh
module load $c gsl
cd $packageHome/tests
for test in *; do
if test -d \$test; then
  cd $packageHome/tests
  echo === \$test: `\$test/test`
fi
done
END
    close(OUT);
    $output = `/bin/bash $TESTFILE.sh`;
    my (@crashes, @failures, @successes);
    while ($output =~ s/=== (\w+): (.*)//) {
      my ($testname, $testout) = ($1, $2);
      if ($testout !~ /^Completed \[(\d+)\/(\d+)\]/) {
        push(@crashes, $testname);
      } elsif ($1 != $2) {
        push(@failures, $testname);
      } else {
        push(@successes, $testname);
      }
    }
    my $testcount = scalar(@crashes) + scalar(@failures) + scalar(@successes);
    if(scalar(@successes) == $testcount) {
      pass("$testcount/$testcount gsl/$c tests passed");
    } else {
      fail(scalar(@successes) . "/$testcount gsl/$c tests passed; " .
           scalar(@crashes) . ' (' . join(',', @crashes) . ') crashed; ' .
           scalar(@failures) . ' (' . join(',', @failures) . ') failed');
    }
  }
}


# lapack
foreach my $c (@COMPILERS) {
  my $packageHome = "/opt/lapack/$c";
  my $testDir = "/opt/lapack/$c/tests";
SKIP: {
  skip "lapack $c not installed", 1 if ! -d $packageHome;
  skip "lapack $c test not installed", 1 if ! -d $testDir;
  open(OUT, ">$TESTFILE.sh");
  print OUT <<END;
#!/bin/bash
. /etc/profile.d/modules.sh
module load ROLLCOMPILER lapack
cd $packageHome/tests
sh ./tests
END
    close(OUT);
    $output = `/bin/bash $TESTFILE.sh|grep -c -i fail`;
    ok($output <= 19, "lapack $c tests");
  }
}

`rm -f $TESTFILE*`;
]]>
</file>

</post>

</kickstart> 
